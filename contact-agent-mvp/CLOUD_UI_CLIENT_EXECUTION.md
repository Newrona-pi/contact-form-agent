# クラウドUI + クライアントサイド実行 要件仕様書

## 概要

現在のcontact-agent-mvpは、UI画面とPython処理（content-agent2）の両方をサーバーサイドで実行していますが、これを以下の構成に変更します：

- **UI画面**: クラウドで提供（URLでアクセス可能）
- **処理実行**: ユーザーの端末で実行（content-agent2）

## 現在の構成

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   ユーザー      │    │   クラウド      │    │   content-agent2 │
│   ブラウザ      │◄──►│   Next.js       │◄──►│   Python処理     │
│                │    │   UI画面        │    │                │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 変更後の構成

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   ユーザー      │    │   クラウド      │    │   ユーザー端末   │
│   ブラウザ      │◄──►│   Next.js       │    │   content-agent2 │
│   (UI表示)      │    │   UI画面        │    │   Python処理     │
│                │    │   (設定生成)    │    │                │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 主要な変更点

### 1. APIエンドポイントの変更

#### 現在のAPI
- `POST /api/run` - サーバーサイドでPythonプロセスを起動
- `GET /api/run/[id]` - 実行状況の取得
- `GET /api/run/[id]/download` - 結果CSVのダウンロード

#### 変更後のAPI
- `POST /api/generate-config` - 設定ファイルの生成とダウンロード
- `POST /api/validate-license` - ライセンスキーの検証
- `GET /api/datasets` - データセット一覧の取得

### 2. フロントエンドの変更

#### 現在の機能
- 設定画面で実行開始ボタンを押すと、サーバーサイドで処理開始
- 実行状況をリアルタイムで監視
- 結果をサーバーから取得

#### 変更後の機能
- 設定画面で設定ファイルを生成・ダウンロード
- ユーザーにcontent-agent2の実行方法を案内
- 結果ファイルのアップロード機能（オプション）

### 3. 処理フローの変更

#### 現在のフロー
1. ユーザーが設定を入力
2. 実行開始ボタンをクリック
3. サーバーサイドでPythonプロセス起動
4. リアルタイムで進捗を監視
5. 完了後、結果をダウンロード

#### 変更後のフロー
1. ユーザーが設定を入力
2. 設定ファイル生成ボタンをクリック
3. 設定ファイル（YAML + CSV）をダウンロード
4. ユーザーがローカルでcontent-agent2を実行
5. 結果ファイルをアップロード（オプション）

## 技術的な実装詳細

### 1. 設定ファイル生成

#### 生成されるファイル
- `config.yaml` - プロファイル情報とテンプレート
- `urls.csv` - 対象URLのリスト（クラウド提供 + ユーザーアップロード）
- `run-instructions.md` - 実行手順の説明

#### 設定ファイルの例
```yaml
# config.yaml
defaults:
  message: "お問い合わせがあります。"
  email: "user@example.com"
  first_name: "太郎"
  last_name: "田中"
  # ... その他のプロファイル情報

settings:
  concurrency: 3
  timeout_sec: 12
  dry_run: true
  show_browser: false

datasets:
  cloud:
    - "industry_it.csv"
    - "industry_finance.csv"
  user:
    - "custom_companies.csv"
```

### 2. データ・テンプレートの棲み分け

#### クラウド側で管理
- **データセット（CSVファイル）**: 業界別の基本データセット
  - `industry_it.csv` - IT業界の企業リスト
  - `industry_finance.csv` - 金融業界の企業リスト
  - `industry_food.csv` - 食品業界の企業リスト
  - その他、汎用的な業界データ

#### ローカル側で管理
- **ユーザー独自のCSVファイル**: ユーザーがアップロード・管理
- **メッセージテンプレート**: 問い合わせ文のテンプレート
- **プロファイルテンプレート**: 送信者情報のテンプレート

#### 棲み分けのメリット
- **リスク軽減**: 個人情報をクラウドに保存しない
- **柔軟性**: ユーザーが独自のデータセットを追加可能
- **セキュリティ**: 機密情報の漏洩リスクを最小化
- **カスタマイズ性**: ユーザー固有のニーズに対応

### 3. クライアントサイド実行のサポート

#### 必要なファイル
- `content-agent2/` ディレクトリ全体
- 実行手順書
- サンプル設定ファイル

#### 実行コマンド例
```bash
cd content-agent2
python -m form_filler.cli --csv urls.csv --data config.yaml --dry-run
```

### 4. ライセンス認証の変更

#### 現在
- サーバーサイドでライセンスキーを検証
- セッション管理で認証状態を保持

#### 変更後
- クライアントサイドでライセンスキーを検証
- ローカルストレージで認証状態を保持
- オフライン環境でも動作可能

## 実装の優先順位

### Phase 1: 基本機能の移行
1. データ・テンプレートの棲み分け実装
2. 設定ファイル生成APIの実装
3. フロントエンドの変更（実行開始→設定ファイル生成）
4. 実行手順書の作成

### Phase 2: ユーザビリティの向上
1. 結果ファイルのアップロード機能
2. 実行履歴の管理
3. エラーハンドリングの改善

### Phase 3: 高度な機能
1. バッチ処理のスケジューリング
2. 複数ユーザー対応
3. 監査ログの実装

## メリット・デメリット

### メリット
- **スケーラビリティ**: サーバーリソースに依存しない
- **プライバシー**: ユーザーデータがサーバーに送信されない
- **オフライン対応**: インターネット接続が不要
- **カスタマイズ性**: ユーザーが独自の処理を追加可能

### デメリット
- **セットアップの複雑性**: ユーザーがPython環境を構築する必要
- **サポートの困難性**: 実行環境の違いによる問題の特定が困難
- **一貫性の欠如**: 実行環境によって結果が異なる可能性

## 移行戦略

### 1. 段階的移行
- 既存のサーバーサイド実行を残しつつ、クライアントサイド実行を追加
- ユーザーが選択できるようにする

### 2. 互換性の維持
- 既存のAPIエンドポイントは非推奨として残す
- 設定ファイルの形式は既存のcontent-agent2と互換性を保つ

### 3. ユーザー教育
- 実行手順書の充実
- トラブルシューティングガイドの提供
- サンプルコードの提供

## 技術的な課題と対策

### 1. ファイル形式の統一
- YAMLファイルの形式をcontent-agent2の期待する形式に合わせる
- CSVファイルのエンコーディングを統一
- クラウド提供CSVとユーザーアップロードCSVの形式統一

### 2. エラーハンドリング
- 設定ファイルの検証機能
- 実行時のエラー情報の収集

### 3. セキュリティ
- ライセンスキーの適切な管理
- 設定ファイルの暗号化（必要に応じて）
- 個人情報のクラウド保存を完全に排除
- ユーザーアップロードデータのローカル管理

## 今後の拡張性

### 1. 分散実行
- 複数端末での並列実行
- クラウドワークフローとの連携
- クラウドデータセットとローカルデータセットの組み合わせ実行

### 2. モニタリング
- 実行状況の可視化
- パフォーマンス分析

### 3. 自動化
- CI/CDパイプラインとの連携
- スケジュール実行

---

このドキュメントは、クラウドUI + クライアントサイド実行への移行計画の概要です。
実装の詳細については、各フェーズごとに詳細設計書を作成することを推奨します。
